import{d as te,C as u,g as v,u as ae,o as se,c as d,e as V,i as L,b as s,k as b,_ as D,F as z,l as H,m as g,t as o,x as U,f as p,w as c,v as _}from"./index-5mvahFkI.js";import{u as T}from"./useapi-BrBtbFnF.js";const ne={class:"p-6 max-w-2xl mx-auto space-y-6"},re={key:0,class:"space-y-4"},oe={class:"font-medium"},le={class:"text-sm"},ue={class:"text-xs text-gray-600"},ie={class:"text-xs text-gray-600"},de={class:"text-xs text-gray-600"},pe={class:"border rounded p-4 bg-gray-50 space-y-2"},me={key:0,class:"text-red-600 font-semibold"},ce={class:"space-y-4"},_e=["onUpdate:modelValue"],ve=["onUpdate:modelValue"],ge=["onUpdate:modelValue"],fe=["onUpdate:modelValue"],he=["onUpdate:modelValue"],ye=["onUpdate:modelValue"],xe=["onClick"],we=["disabled"],ke={class:"flex gap-4"},Se=["disabled"],$e=te({__name:"Scenes",setup(Ve){const f=u(()=>{if(!i.value)return 0;const e=new Date(i.value.start_time),a=new Date(i.value.end_time);return Math.round((a.getTime()-e.getTime())/6e4)}),h=u(()=>l.value.reduce((e,a)=>e+a.duration,0)),x=u(()=>f.value-h.value),w=u(()=>h.value>f.value),$=u(()=>x.value>0),M=u(()=>l.value.length>0&&!w.value),k=ae().params.id,{fetchData:I,data:i,error:C,loading:R}=T("GET",`/api/v0/core/${k}`),{fetchData:E,data:y,error:N,loading:j}=T("GET",`/api/v0/scenes/${k}`),{fetchData:q,error:A,loading:J}=T("POST",`/api/v0/scenes/${k}/create/`),B=v(""),P=v(""),m=v(""),S=v(""),l=v([]);function O(e){const[a,t,r]=e.split(":").map(Number);return a*36e5+t*6e4+r*1e3}const F=u(()=>y.value?y.value.map(e=>{const a=Math.round((O(e.end_time)-O(e.start_time))/6e4);return{name:e.name,duration:a,speaker:e.speaker.phone_number,speaker_first_name:e.speaker_first_name,speaker_last_name:e.speaker_last_name,descriptions:e.descriptions,start:e.start_time,end:e.end_time}}):[]);se(async()=>{await I(),C.value&&(B.value=C.value),await E(),N.value?P.value=N.value:y.value&&(l.value=y.value.map(e=>{const[a,t,r]=e.start_time.split(":").map(Number),[n,Z,De]=e.end_time.split(":").map(Number),ee=n*60+Z-(a*60+t);return{name:e.name,duration:ee,speaker:e.speaker.phone_number,speaker_first_name:e.speaker_first_name,speaker_last_name:e.speaker_last_name,descriptions:e.descriptions}}))});function K(){l.value.push({name:"",duration:5,speaker:"",speaker_first_name:"",speaker_last_name:"",descriptions:"",start:"",end:""})}function Q(e){l.value.splice(e,1)}function W(e,a){return new Date(e.getTime()+a*6e4)}function G(e){const a=String(e.getHours()).padStart(2,"0"),t=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0");return`${a}:${t}:${r}`}const X=async()=>{if(m.value="",S.value="",!i.value){m.value="Event data not loaded yet.";return}if(!l.value.length){m.value="لطفاً حداقل یک بخش اضافه کنید.";return}if(w.value){m.value=`مدت تخصیص‌یافته (${h.value} دقیقه) از کل زمان رویداد (${f.value} دقیقه) بیشتر است!`;return}let e=new Date(i.value.start_time);const a=l.value.map(t=>{const r=new Date(e),n=W(r,t.duration);return e=n,{speaker:t.speaker,name:t.name,start_time:G(r),end_time:G(n),speaker_first_name:t.speaker_first_name,speaker_last_name:t.speaker_last_name,descriptions:t.descriptions}});if(await q(a),A.value){m.value=A.value;return}S.value="تمام بخش‌ها با موفقیت ساخته شدند.",l.value=[]},Y=async()=>{await E()};return u(()=>{if(!i.value)return[];new Date(i.value.start_time)}),(e,a)=>(p(),d("div",ne,[V(D,{message:"",error:B.value,loading:b(R)},null,8,["error","loading"]),V(D,{message:"",error:P.value,loading:b(j)},null,8,["error","loading"]),V(D,{message:S.value,error:m.value,loading:b(J)},null,8,["message","error","loading"]),F.value.length?(p(),d("div",re,[a[0]||(a[0]=s("h3",{class:"font-semibold"},"صحنه‌های قبلی:",-1)),(p(!0),d(z,null,H(F.value,(t,r)=>(p(),d("div",{key:`existing-${r}`,class:"space-y-1 border-l-4 border-gray-400 pl-4 py-2 bg-gray-50 rounded"},[s("div",oe,o(t.name)+" ("+o(t.duration)+" دقیقه)",1),s("div",le,"سخنران: "+o(t.speaker_first_name)+" "+o(t.speaker_last_name),1),s("div",ue,o(t.descriptions),1),s("div",ie,o(t.start),1),s("div",de,o(t.end),1)]))),128))])):L("",!0),s("div",pe,[s("div",null,[a[1]||(a[1]=g(" مدت کل رویداد: ")),s("strong",null,o(f.value),1),a[2]||(a[2]=g(" دقیقه "))]),s("div",null,[a[3]||(a[3]=g(" مدت تخصیص‌یافته: ")),s("strong",null,o(h.value),1),a[4]||(a[4]=g(" دقیقه "))]),s("div",null,[a[5]||(a[5]=g(" زمان باقی‌مانده: ")),s("strong",{class:U(x.value>=0?"text-green-600":"text-red-600")},o(x.value)+" دقیقه ",3)]),w.value?(p(),d("div",me,"خطا: مجموع زمان صحنه‌ها نباید بیشتر از مدت رویداد باشد!")):L("",!0)]),s("div",ce,[(p(!0),d(z,null,H(l.value,(t,r)=>(p(),d("div",{key:r,class:"space-y-2 border p-4 rounded"},[c(s("input",{"onUpdate:modelValue":n=>t.name=n,placeholder:"نام صحنه",class:"input w-full"},null,8,_e),[[_,t.name]]),c(s("input",{"onUpdate:modelValue":n=>t.duration=n,type:"number",placeholder:"مدت (دقیقه)",class:"input w-full"},null,8,ve),[[_,t.duration,void 0,{number:!0}]]),c(s("input",{"onUpdate:modelValue":n=>t.speaker=n,placeholder:"شماره تماس سخنران",class:"input w-full"},null,8,ge),[[_,t.speaker]]),c(s("input",{"onUpdate:modelValue":n=>t.speaker_first_name=n,placeholder:"نام سخنران",class:"input w-full"},null,8,fe),[[_,t.speaker_first_name]]),c(s("input",{"onUpdate:modelValue":n=>t.speaker_last_name=n,placeholder:"نام خانوادگی سخنران",class:"input w-full"},null,8,he),[[_,t.speaker_last_name]]),c(s("textarea",{"onUpdate:modelValue":n=>t.descriptions=n,placeholder:"توضیحات",class:"input w-full",rows:"2"},null,8,ye),[[_,t.descriptions]]),s("button",{onClick:n=>Q(r),class:"text-red-600 hover:underline"},"حذف",8,xe)]))),128)),s("button",{onClick:K,disabled:!$.value,class:U(["rounded px-4 py-2",$.value?"bg-gray-200 hover:bg-gray-300":"bg-gray-100 cursor-not-allowed opacity-50"])}," افزودن ",10,we)]),s("div",ke,[s("button",{onClick:X,disabled:!M.value,class:U(["flex-1 text-white rounded px-4 py-2",M.value?"bg-blue-600 hover:bg-blue-700":"bg-gray-300 cursor-not-allowed opacity-50"])}," ارسال ",10,Se),s("button",{onClick:Y,class:"flex-1 bg-gray-100 hover:bg-gray-200 rounded px-4 py-2"},"🔄 تازه‌سازی")])]))}});export{$e as default};
